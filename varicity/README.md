# VariCity

VariCity is a 3D visualization relying on the city metaphor to display zones of high density of variability implementations in a single system.
The city is built by creating building, corresponding to classes, and streets, grouping every class linked to the street's starting building.

In order to build the city, VariCity parses the JSON files produced by symfinder and metrics-extension to produces a graph composed by classes and their links. The starting points of this graph are API classes, defined by the user.
API classes are the first buildings placed on the "root" street, and classes linked to them are placed in their corresponding streets.
Links used to produce this hierarchy can be configured, depending on their type (inheritance or usage), and orientation (see the [Configuration](#configuration) section).

In order to use VariCity to visualize your project, you need to first analyse it using the symfinder toolchain. [Go to symfinder's documentation](./../metrics-extension/symfinder/README.md)
And optionally retrieve other metrics from external sources such as SonarCloud using metrics-extension. [Go to metrics-extension's documentation](./../metrics-extension/README.md)

Pre-generated JSON files resulting from the analysis of 10 projects by symfinder are provided in the `pre_generated_visualizations.zip` archive and ready to be used by VariCity.


## Technical Requirements

- Docker
    - Instructions to install Docker are available [here](https://docs.docker.com/get-docker/).
- Docker Compose
    - Instructions to install Docker Compose are available [here](https://docs.docker.com/compose/install/#install-compose).

**Note:** By default, on a GNU/Linux host, Docker commands must be run using `sudo`. Two options are available for you in order to run the project:
- Follow [these short steps](https://docs.docker.com/install/linux/linux-postinstall/#manage-docker-as-a-non-root-user) to allow your user to call Docker commands,
- Preface the scripts calls with `sudo`.


## Running VariCity

First need to start varicity-backend in `varicity-backend` before starting varicity [Go to varicity-backend's documentation](./../varicity-backend/README.md)

All the scripts below are located and executed from the `varicity` directory, located at the root of the project.

*Note:* Before using VariCity, you should have a `generated_visualizations` directory (in the directory containing this README file) containing files generated by symfinder.
Such files can be obtained either:
- by running symfinder on a project of your choice (see [symfinder's documentation](./../metrics-extension/symfinder/README.md)).
- by unzipping the `pre_generated_visualizations.zip` in this directory.

### Reusing the existing Docker image

The following Docker image hosted on the [Docker Hub](https://hub.docker.com/) allows to use VariCity without needing to build it.
```
deathstar3/varicity
```

Run VariCity by running


- On GNU/Linux and macOS

    ```
    ./varicity.sh
    ```

- On Windows

    ```
    varicity.bat
    ```

*Note:* As for symfinder, the Docker image is automatically downloaded by Docker with the tag `vissoft2021` if it is not found on the host system.

### Building VariCity

**This step is only needed if you edited VariCity's source code.**

You can build VariCity's Docker images by running

```
./build.sh
```

Then, run symfinder using the local images that you just built.

```
./varicity.sh --local
```


### Run without Docker

To run VariCity on your local machine, you first need to install [NodeJS](https://nodejs.org/en/). Then, go to the ```varicity``` folder at the root of the project and run ```npm install```, then ```npm start```.
Before using VariCity, make sure to copy the JSON files produced by symfinder (found in `generated_visualizations/data`) in the ```varicity/symfinder_files``` folder.

## Using VariCity

To access the visualization once VariCity is running, you need to access ```localhost:9090``` via a web browser.

### Select a project

To select the project you want to visualize, head to the side menu and click on Project selection, then on the name of your analysed project.
![project selection](./../readme_files/varicity/Project_selection.png)

You will most probably have to wait for a few seconds while the file is getting parsed before the visualization actually appears on your screen.

### Exploring your city

Once the visualization is up, you can explore the city by moving the camera with the following controls:

- Left mouse button: Drag to turn the camera
- Right mouse button: Drag to move the camera
- Scroll up/down: Zoom in/out

You can use the search bar at the top of the side menu to search for a specific class and focus the camera on its corresponding building in the visualization (with autocompletion).

#### Buildings

Buildings represent classes and wear information with how they are displayed:

- Size:
    - Height: by default, the height of a building depends on the number of method variants of the class.
    - Width: by default, the width of a building depends on the number of constructor variants of the class.
- Color: the color of a building depends on the tags of its corresponding class (see the config section)
- Models: Some building may have additional features to their 3D model:
    - Design patterns:
        - Chimneys:  A building with chimneys represents a Factory class  
          ![factory](./../readme_files/varicity/Factory.png)
        - Dome: A building with a dome represents a Strategy class  
          ![strategy](./../readme_files/varicity/Strategy.png)
        - Inverted pyramid: A building with an inverted pyramid represents a Template class  
          ![template](./../readme_files/varicity/Template.png)
        - Sphere: A building with a sphere represents a Decorator class  
          ![decorator](./../readme_files/varicity/Decorator.png)
    - Pyramid and outline: The API classes have a pyramid and an outline added to their representation  
      ![api](./../readme_files/varicity/API.png)



#### Links

In VariCity, you can also see relations between your classes, in different ways:

- Streets: A street is created when a VP is parsed, and all its variants are displayed next to the street.
- Aerial links: By default, inheritance links (EXTENDS and IMPLEMENTS) are displayed as aerial links. The building at the darker side is the source (subclass), and the one at the brighter side is the destination (superclass).  
  ![aerial link](./../readme_files/varicity/Aerial_link.png)  
  *On the left, the bright side of the link means that the yellow building is the super class of the blue building on the other hand, at the dark side.*
- Underground links / Underground streets: By default, an underground link between two buildings shows the DUPLICATE links, unique to VariCity and not present in the symfinder files. It means that the starting building is a variant of the target building, but could not be placed in the target's street because it had already been drawn. Thus, each building is displayed only once.
  Underground links are also oriented, and the source class is represented by the building having a vertical street underneath itself. The destination class is directly linked by the underground link.
  The depth of the vertical part depends on the difference of usage level between the two classes.  
  ![underground link](./../readme_files/varicity/Underground_link.png)  
  *Here, an underground street goes from the left to the right side of the image. This means that the class on the left side is also present in the district of the class on the right side.*

By clicking on a building, you can display the links leading to or coming from it, as well as detailed info on the side menu (types, attributes, links, etc.) in the "Object details" section.

![building selected](./../readme_files/varicity/Building_selected.png)  
*The highlighted building has all its links displayed*



### Configuration

![config menu](./../readme_files/varicity/Configuration_menu.png)

In the side menu, you can change various configuration variables in the "Config parameters" submenu:

- Usage level: Change the level of usage used to display the city (default is 4).
- Orientation: Can be IN, OUT, or IN_OUT. Used to change the orientation of the links used to establish the usage level of each element.
- hierarchy_links: Contains the list of link types used to compose the graph of the city.
- api_classes: For each project, list of names of the entry point classes used as starting points to build the city.
- Building:
    - padding: will change the space between each building
    - colors:
        - faces: Contains the colors list in which the buildings should be displayed according to their tags. Every colors list in the configuration is ordered, and if a class has two of the listed tags, the first one in the list will be taken into account. Putting a ```!```before a tag name will set the color for each class that does not have the tag.
          Example (default configuration):
          ![colors list](./../readme_files/varicity/Colors_list.png)
        - edges: Colors list for the outlines of the buildings (by default, there is only a black outline for the API classes).
- district:
    - padding: Space between every district (default is 0)
    - colors > faces: Colors list for the types of package (tag PACKAGE is for the root street, tag VP is for the other streets).
- link:
    - colors: Colors list for the links.
    - display:
        - air_traffic: List of tags corresponding to the links that should be displayed as aerial links.
        - underground_road: List of tags corresponding to the links that should be displayed as underground links.
- blacklist: Each class or package in this list will be excluded from visualization.
- variables: Names of the variables used to determine the height and the width of the buildings (do not change unless you know the variable names in the source code).

The default configuration is retrieved from the ```config/config.yaml``` file in the ```varicity ``` folder.
Its structure is identical to the menu displayed on the visualization.
This file can be modified at any time. However, you will need to rerun VariCity to take the changes into account.


An additional attribute in this file is `default_level`, used to determine the default usage level (default is 4).

### Configure VariCity for your project

The `api_classes` section of VariCity's configuration file (being the `config/config.yaml` file in the `varicity ` folder) allows defining default entry point classes for your project.

#### Example:

Let's suppose that you defined the following experiment in symfinder (see [Using symfinder on your project](#using-symfinder-on-your-project) section for more details on how to define a new experiment in symfinder):

```yaml
myproject:
  repositoryUrl: https://github.com/myusername/project1
  sourcePackage: .
  tagIds:
    - customtag
```

In the `api_classes` section of VariCity's configuration file, you may add a new entry for your project, having for name the pattern `<experiment_name>_<experiment_tag_or_commit>`.

```yaml
api_classes:
  - "my.first.EntryPointClass"
  - "my.second.EntryPointClass"
```

This allows you to create different pre-configurations for every commit / tag of a same project.

#### Example:

Let's suppose that you defined the following experiment in symfinder:

```yaml
myproject:
  repositoryUrl: https://github.com/myusername/project1
  sourcePackage: .
  tagIds:
    - customtag1
    - customtag2
  commitIds:
    - customcommit 
```

In the `api_classes` section of VariCity's configuration file, you can define entries wih the following names:

```yaml
api_classes:
  - "my.first.EntryPointClass"
  - "my.second.EntryPointClass"
 
```